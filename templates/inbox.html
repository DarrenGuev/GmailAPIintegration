{% extends "base.html" %}
{% block Head %}
<title>EZ Mail - Inbox</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
<link rel="stylesheet" href="{{ url_for('static', filename='main.css') }}" />
<link rel="stylesheet" href="{{ url_for('static', filename='inbox.css') }}" />
<link href="https://fonts.googleapis.com/css?family=Lato&display=swap" rel="stylesheet" />
<link href="https://fonts.googleapis.com/css?family=Judson&display=swap" rel="stylesheet" />
{% endblock %}

{% block Body %}
<div class="v6_2">
  <div class="v8_12">
    <span class="v8_13">EZ mail</span>
    <div class="top-right-nav">
      <div class="Inbox-container">
        <div class="inbox-nav" onclick="toggleInboxDropdown()">
          Inbox
        </div>
        <div class="dropdown-menu" id="InboxDropdown">
          <a href="/" class="dropdown-item">Home</a>
        </div>
      </div>
      <div class="profile-container">
        <div class="profile-icon" onclick="toggleDropdown()">
          <!-- user icon -->
          <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="12" cy="8" r="4" fill="currentColor" />
            <path d="M6 21v-2a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v2" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" />
          </svg>
        </div>

        <div class="dropdown-menu" id="profileDropdown">
          <div class="dropdown-header">
            <div class="user-avatar">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="12" cy="8" r="4" fill="currentColor" />
                <path d="M6 21v-2a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v2" stroke="currentColor" stroke-width="2"
                  stroke-linecap="round" />
              </svg>
            </div>
            <div class="user-info">
              <div class="user-email">{{ session.user_email }}</div>
            </div>
          </div>

          <div class="dropdown-divider"></div>
          <a href="/logout" class="dropdown-item">
            <!-- logout svg -->
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" />
              <polyline points="16,17 21,12 16,7" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
              <line x1="21" y1="12" x2="9" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
            </svg>
            Logout
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Adapted inbox layout -->
  <div class="container" style="padding-top: 60px; padding-bottom: 60px;">
    <div class="card shadow-lg inbox-card mx-auto">
      <!-- Orange rounded header like screenshot -->
      <div class="inbox-header d-flex align-items-center justify-content-between px-4">
        <div class="header-center">Inbox</div>
      </div>

      <div class="card-body p-0">
        <div class="row g-0">
          <!-- Left: message list -->
          <div class="col-md-4 inbox-left border-end">
            <div class="scroll-box">
              <div class="list-group list-group-flush" id="messageList" role="tablist">
                {% if emails %}
                {% for mail in emails %}
                <button type="button" class="list-group-item list-group-item-action email-row"
                  data-name="{{ mail.name }}" data-email="{{ mail.email }}" data-date="{{ mail.date }}"
                  data-subject="{{ mail.subject }}" data-body="{{ mail.body_text | e }}">
                  <div class="small text-muted">From:</div>
                  <div class="fw-bold">{{ mail.name }}</div>
                  <div class="small text-muted mt-1">Subject:</div>
                  <div class="text-truncate">{{ mail.subject }}</div>
                  <div class="small text-muted text-truncate">{{ mail.body_text }}</div>
                </button>
                {% endfor %}
                {% else %}
                <div class="p-3 no-emails-text">No emails to display.</div>
                {% endif %}
              </div>
            </div>
          </div>

          <!-- Right: message preview -->
          <div class="col-md-8 inbox-right p-4">
            <div id="messagePreview" class="h-100 d-flex flex-column">
              <div class="preview-meta mb-3">
                <h5 id="previewSubject" class="mb-1">(No message selected)</h5>
                <div class="text-muted" id="previewFrom">—</div>
                <div class="text-muted small" id="previewDate"></div>
                <hr>
              </div>
              
              <!-- Message Content Area -->
              <div class="preview-body flex-grow-1" id="previewBody" style="white-space: pre-wrap;">
                <p class="text-muted">Select a message from the left to view its details.</p>
              </div>

              <!-- Reply Interface (hidden by default) -->
              <div id="replyInterface" class="reply-interface" style="display: none;">
                <div class="reply-header mb-3" style="background: rgba(113, 1, 23, 1); color: white; padding: 15px; border-radius: 10px 10px 0 0; margin: -15px -15px 15px -15px;">
                  <h6 class="mb-0" style="font-family: 'Judson', serif; font-weight: bold;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 8px;">
                      <path d="M9 17l6-6-6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Reply to: <span id="inlineReplyToName">Sender</span>
                  </h6>
                </div>
                
                <form id="inlineReplyForm" action="/send" method="post">
                  <!-- Hidden inputs for recipient and subject -->
                  <input type="hidden" id="inlineReplyToEmail" name="to" value="">
                  <input type="hidden" id="inlineReplySubject" name="subject" value="">
                  
                  <!-- Only show the message textarea -->
                  <div class="mb-3">
                    <label for="inlineReplyMessage" class="form-label" style="color: rgba(77, 70, 70, 1); font-family: 'Judson', serif; font-weight: 500; font-size: 16px;">
                      Your Reply:
                    </label>
                    <textarea class="form-control" id="inlineReplyMessage" name="message" rows="8" 
                      placeholder="Type your reply here..." required 
                      style="border-radius: 8px; border: 2px solid rgba(156, 142, 129, 1); font-family: 'Judson', serif; resize: vertical; background: white; font-size: 14px;">
                    </textarea>
                  </div>
                  
                  <div class="d-flex gap-2 justify-content-end">
                    <button type="button" class="btn btn-secondary btn-sm" id="cancelReplyBtn"
                      style="border-radius: 8px; padding: 8px 16px; font-family: 'Lato', sans-serif; font-weight: bold; font-size: 12px;">
                      Cancel
                    </button>
                    <button type="submit" class="btn btn-sm" 
                      style="background-color: rgba(84, 98, 123, 1); color: white; border: none; border-radius: 8px; padding: 8px 16px; font-family: 'Lato', sans-serif; font-weight: bold; font-size: 12px;">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 4px;">
                        <path d="M22 2L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                      Send Reply
                    </button>
                  </div>
                </form>
              </div>

              <div class="preview-actions mt-3 d-flex gap-2">
                <button class="btn btn-sm btn-outline-primary" id="replyBtn">Reply</button>
                <!-- <button class="btn btn-sm btn-outline-secondary" id="deleteBtn">Delete</button> -->
                <a href="/" class="btn btn-sm btn-outline-secondary ms-auto">← Back</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  let currentEmailData = {};

  function toggleInboxDropdown() {
    document.getElementById("InboxDropdown").classList.toggle("show");
  }

  function toggleDropdown() {
    const dropdown = document.getElementById("profileDropdown");
    dropdown.classList.toggle("show");
  }

  window.addEventListener('click', function (event) {
    const dropdown = document.getElementById("InboxDropdown");
    if (!event.target.closest('.Inbox-container')) {
      dropdown.classList.remove('show');
    }
  });

  window.addEventListener('click', function (event) {
    const dropdown = document.getElementById("profileDropdown");
    if (!event.target.closest('.profile-container')) {
      dropdown.classList.remove('show');
    }
  });

  // Client-side selection handling
  document.addEventListener('DOMContentLoaded', function () {
    const rows = document.querySelectorAll('.email-row');
    const previewSubject = document.getElementById('previewSubject');
    const previewFrom = document.getElementById('previewFrom');
    const previewDate = document.getElementById('previewDate');
    const previewBody = document.getElementById('previewBody');
    const replyBtn = document.getElementById('replyBtn');
    const replyInterface = document.getElementById('replyInterface');
    const cancelReplyBtn = document.getElementById('cancelReplyBtn');

    rows.forEach(row => {
      row.addEventListener('click', function () {
        rows.forEach(r => r.classList.remove('active'));
        this.classList.add('active');

        const from = this.dataset.name || '';
        const email = this.dataset.email || '';
        const date = this.dataset.date || '';
        const subject = this.dataset.subject || '(no subject)';
        const body = this.dataset.body || '';

        // Store current email data for reply functionality
        currentEmailData = {
          name: from,
          email: email.replace(/[<>]/g, ''), // Remove < > brackets
          subject: subject,
          originalBody: body
        };

        // Hide reply interface and show message content
        replyInterface.style.display = 'none';
        previewBody.innerHTML = `<p>${body || '(no content)'}</p>`;
        
        previewSubject.textContent = subject;
        previewFrom.innerHTML = '<strong>From:</strong> ' + from + ' ' + (email ? (' ' + email) : '');
        previewDate.textContent = date;
        
        // Enable reply button when an email is selected
        replyBtn.disabled = false;
      });
    });

    // Reply button click handler
    replyBtn.addEventListener('click', function() {
      if (!currentEmailData.email) {
        alert('Please select an email to reply to.');
        return;
      }

      // Hide the message content and show reply interface
      previewBody.innerHTML = '';
      replyInterface.style.display = 'block';

      // Populate hidden form fields with current email data
      document.getElementById('inlineReplyToName').textContent = currentEmailData.name;
      document.getElementById('inlineReplyToEmail').value = currentEmailData.email;
      
      // Add "Re: " prefix if not already present
      let replySubject = currentEmailData.subject;
      if (!replySubject.toLowerCase().startsWith('re:')) {
        replySubject = 'Re: ' + replySubject;
      }
      document.getElementById('inlineReplySubject').value = replySubject;
      
      // Clear the reply message textarea and focus it
      const textarea = document.getElementById('inlineReplyMessage');
      textarea.value = '';
      textarea.focus();
    });

    // Cancel reply button handler
    cancelReplyBtn.addEventListener('click', function() {
      // Hide reply interface and show original message content
      replyInterface.style.display = 'none';
      previewBody.innerHTML = `<p>${currentEmailData.originalBody || '(no content)'}</p>`;
    });

    // Initially disable reply button
    replyBtn.disabled = true;
  });
</script>
{% endblock %}